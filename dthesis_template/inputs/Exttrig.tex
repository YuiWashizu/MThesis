\chapter{外部トリガを用いた応答評価試験}
この章では，外部トリガを用いた粒子線に対する応答評価試験について述べる．\ref{sec:extplan}節で外部トリガを用いた応答評価試験の概要，\ref{sec:extsetup}節で外部トリガでデータ取得をする際のセットアップ，\ref{sec:exthow}節で手順，\ref{sec:extconc}節で取得データ結果を示し，\ref{sec:extsum}節で考察を行なっている．

\section{外部トリガを用いた応答評価試験概要}
\label{sec:extplan}
この節では，Quad Chip RD53Aモジュールに対して行われる品質試験について述べる．\ref{sec:masspro}節で述べたように，現在実機で用いるモジュールを量産するための準備として，プロトタイプ版のASICが4 $\mathrm{Chip}$搭載されたQuad Chip RD53Aモジュールで量産体制の確認が計画されている．この時に，バンプボンディングに異常が無いかを確認するための試験が，外部トリガを用いた応答評価試験である．現在計画されている試験は，クーリングボックスと呼ばれる，温度が低温に維持された小さな箱の中で行い，トリガには前章で述べたHitOR信号ではなく，トリガシンチの信号を外部トリガとして用いる．トリガシンチは箱の上部に取り付けられたソースホルダによって固定され，トリガシンチの信号は，クーリングボックスの外部にある読み出しシステムによって，YARRのDAQへ伝達される．トリガシンチの構成については\ref{sec:extsetup}節で詳しく述べる．計画されている外部トリガを用いた応答評価試験セットアップを図\ref{fig:trigplan}に示す．

\begin{figure}[h]
  \centering
  \includegraphics[width=15cm]{./figure/trigplan.png}
  \caption{計画されている外部トリガを用いた応答評価試験セットアップ}
  \label{fig:trigplan}
\end{figure}

計画されているセットアップに近付けるようにして，外部トリガを用いた応答評価試験を行なった．

%線源とモジュールの間にシンチレータを配置し，そのシンチレータに粒子が入射した時の発光をMPPCで検出し信号として読み出すことで，トリガに用いる．このシンチレータとMPPCが合わさったものを以降トリガシンチと呼ぶ．トリガシンチは非常にコンパクトな環境で用いられることや，線源とモジュールの間に配置されることから，なるべく小さく，粒子線を遮ることのないように薄くあることが要求されている．このセットアップで可能な外部トリガを用いた応答評価試験の手法を考えた．


\section{外部トリガを用いた応答評価試験セットアップ}
\label{sec:extsetup}
今回行なった外部トリガを用いた応答評価試験のセットアップを図\ref{fig:extsetup}に示す．主にセルフトリガの際と変わらず，RD53A搭載のSingle Chip Card(SCC)とFPGAボード，PCを用いて読み出しシステムを構成している．読み出しASICとFPGAボードは，FMC-mDP変換ボードを用いてケーブルにて接続を行い，FPGA内部でASICからのデータ信号の処理を行なった．また，高速通信用インターフェースでPCとFPGAボードを接続し，データ転送を行なった．そして，これらに加え，今回は外部トリガにトリガシンチを用いるため，トリガシンチ，トリガシンチ信号読み出しシステム，ソースホルダが存在する．トリガシンチ信号読み出しシステムのDPコネクタとアダプタカードのport Dが繋げられている．また，将来的にQuad Chipモジュールを読み出すことを考えて，FMC-mDP変換ボードはFPGAボードのHPCコネクタに取り付けられており，FPGAボードにもHPCから信号を受け取れるファームウェアを実装した．HPCはLPCよりも多くの信号が受け取れるコネクタである．\par

\begin{figure}[h]
  \centering
  \includegraphics[width=15cm]{./figure/extsetup.png}
  \caption{トリガシンチによるデータ取得のセットアップの様子}
  \label{fig:extsetup}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=15cm]{./figure/extsetupcab.png}
  \caption{トリガシンチによるデータ取得のセットアップ配線図}
  \label{fig:extsetupcab}
\end{figure}

今回SCCの電源，センサ，読み出し基板，MPPCに印加した電圧を表\ref{tab:extvol}に示す．
\begin{table}[h]
  \centering
  \caption{今回RD53Aとセンサに供給した電圧}
  \begin{tabular} {|l|cc|c|c|c|} \hline
     & RD53A & RD53A & ピクセル & 読み出し & \\ 
     & アナログ回路 & デジタル回路 & センサ & 基板 & MPPC \\ \hline
    印加電圧[$\mathrm{V}$] & 1.80 & 1.80 & -50 & $\pm$ 5.5 & 58\\ \hline
  \end{tabular}
  \label{tab:voltage}
\end{table}


\subsection{トリガシンチ}
今回トリガシンチに使用したシンチレータと，MPPCをシンチレータに取り付けた様子を図\ref{fig:scin}に示す．図中のライトガイドとは，シンチレータに粒子が入射した時に発光した光を効率よくMPPCまで伝えるための部品である．また，\ref{sec:extplan}節でも述べたように，非常にコンパクトな環境での利用を目的としているため，トリガシンチは箱の中，読み出し回路は箱の外で使用される．それに伴って，MPPCの足は約30 $\mathrm{cm}$のケーブルをはんだづけすることで延長し，トリガシンチの信号を箱の外まで伝えられるようにしてある．また，荷電粒子がトリガシンチに遮蔽され，モジュールまで届かなくなることがないように，シンチレータは0.5 $\mathrm{mm}$と非常に薄いものを使用している．シンチレータは光収集率をよくするために，白い紙で覆ったのち，MPPCと共に黒テープで遮光を行なった．その様子を図\ref{fig:trigscin1}に示す．トリガシンチを構成する要素えあるMPPCとシンチレータについて以降述べる．

\begin{figure}[h]
  \centering
  \begin{minipage}[b]{0.45\linewidth}
    \centering
    \includegraphics[width=6cm]{./figure/trigscin.png}
    \subcaption{使用したシンチレータとライトガイド}
    \label{fig:scin}
  \end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
    \centering
    \includegraphics[width=6cm]{./figure/trigscin1.png}
    \subcaption{MPPCを取り付け，遮光したトリガシンチ}
    \label{fig:trigscin}
  \end{minipage}
  \caption{0.5mmのシンチレータの様子}
  \label{fig:trigscin1}
\end{figure}


\subsubsection*{MPPC}
MPPCとは，Silicon Photomultipliers(SiPM)と呼ばれるデバイスの一種であり，複数の半導体光検出器・アバランシェフォトダイオード(APD)から成るフォトンカウンティングデバイスである．本論文で用いたMPPC・HAMAMATSU S13360-1325CSは，$1.3 \times 1.3 \mathrm{mm^2}$の受光面に$25 \times 25 \mathrm{\mu m^2}$のAPDが敷き詰められている．MPPCの構成を図\ref{fig:APD}に示す．

\begin{figure}[h]
  \centering
  \includegraphics[width=8cm]{./figure/apd.png}
  \caption{MPPCの構成\cite{03handbo69:online}}
  \label{fig:APD}
\end{figure}

全てのAPDの読み出し線，および電圧供給の線は共通していて，全てのAPDピクセルからのシグナルの総和が1つのMPPCからの出力として得られる構造になる．MPPCでは各APDピクセルからの応答が良く揃っているために、総和として出力されるシグナル$Q_{total}$は式\ref{eq:photon}で示されるように光子を受光したピクセル数$N$に1つのAPDから得られるシグナル$Q$をかけた値となる

\begin{eqnarray}
  \label{eq:photon}
  Q_{total} = N \times Q
\end{eqnarray}

受光したピクセル数は、光が微弱である時入射する光量に比例するため， MPPCは非常に高いフォトンカウンティング能力を備えている．

\subsubsection*{プラスチックシンチレータ}
シンチレータとは，放射線のエネルギーを吸収し，内部で励起あるいは電離が起こることで発光する物質である．材質には，無機結晶や液体など様々あるが，本論文では，プラスチックシンチレータを用いた．

%\subsection{トリガシンチの信号読み出し基板}
%本研究を行うにあたって，MPPCからの信号をYARRのDAQシステムのトリガとして使用できるように波形整形できるシステムを作成した．トリガシンチの信号は読み出し基板1で増幅され，コンパレータによってアナログデジタル変換される．その後，ATLYSにてDelayされ，読み出し基板2によってTTLからLVDS変換され，DPコネクタから信号が出力される仕組みである．読み出し基板にDelay機能が実装されていないため，このように2枚の読み出し基板とFPGAボードで構成されている．
%
%\begin{figure}[h]
%  \centering
%  \includegraphics[width=15cm]{./figure/exttriggersetup.png}
%  \caption{トリガシンチの信号を読み出すシステム全体像}
%  \label{fig:exttriggersetup}
%\end{figure}
%
%\begin{figure}[h]
%  \centering
%  \includegraphics[width=10cm]{./figure/exttriggersignal.png}
%  \caption{トリガシンチの信号がYARR-DAQに伝わるまでの様子}
%  \label{fig:exttriggersignal}
%\end{figure}
%
%
\subsection{読み出し基板}
本研究を行うにあたって，MPPCからの信号を波形整形する基板を作成した．基板を図\ref{fig:pcb}に示す．主に，電圧供給回路，反転増幅回路，コンパレータ回路，LVDS変換回路から構成されている．基板はKiCADというCERN開発のオープンソースプリント基板CADを用いて設計・作成した．LEMO1からは増幅されたMPPCのアナログ信号を，LEMO2からはコンパレータによって閾値電圧と比較することで変換されたデジタル信号を，DPからはTTLだったデジタル信号が変換されてLVDS出力のデジタル信号を読み出すことができる．その3点についてオシロスコープで観測した波形を図\ref{fig:extosiro}に示す．トリガシンチに荷電粒子が入射した信号を得たいため，オシロスコープの様子から，コンパレータの比較電圧は75 $\mathrm{mV}$とした．

\begin{figure}[h]
  \centering
  \begin{minipage}[b]{0.45\linewidth}
    \centering
    \includegraphics[width=7cm]{./figure/pcb.png}
    \subcaption{基板の様子}
    \label{fig:pcb}
  \end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
    \centering
    \includegraphics[width=8cm]{./figure/pcbosiro.png}
    \subcaption{動作確認したオシロスコープの様子(コンパレータの比較電圧は150 $\mathrm{mV}$)}
    \label{fig:extosiro}
  \end{minipage}
  \caption{トリガシンチの信号を波形整形する基板}
\end{figure}


\subsection{ソースホルダ}
ソースホルダの外観を図\ref{fig:sourceholder}に示す．クーリングボックス内で使用することを想定し，コンパクトな作りになっている．これは，FreeCADというオープンソース汎用3D CADモデラで設計し，3Dプリンタを用いて作成した．ソースホルダは箱，蓋，軸，留め具の4パーツに分かれていて，蓋の部分には線源を固定するための窪みが存在する．

\begin{figure}[h]
  \centering
  \includegraphics[width=15cm]{./figure/sourceholder.png}
  \caption{ソースホルダの様子}
  \label{fig:sourceholder}
\end{figure}

\section{応答評価試験手順}
\label{sec:exthow}
%まず，前章で述べたようなトリガシンチの信号がFPGAまで伝達され，処理されているかの確認を行った．その確認の様子を図に\ref{fig:extwf}に示す．
%\begin{figure}[h]
%  \centering
%  \includegraphics[width=17cm]{./figure/extWF.png}
%  \label{fig:extwf}
%  \caption{VivadoのLogic Analyzerでトリガシンチからの信号を確認した様子}
%\end{figure}

%今回は''ext\_trig\_i[0:0]''にのみ信号を入力しているため，その部分のみが0から1へと変化している．また，''int\_trig''も0から1に変化していることから，ファームウェアにてトリガシンチの信号の受信・処理が正常に行われていることが確認できる．\par
第3章で述べたような動作確認を行ったのち，Latency Scanを行なった．実際の応答試験では，線源とモジュールの間にトリガシンチを配置するが， 荷電粒子がトリガシンチに遮られ，ASICまで届かないことを避けるため，Latency Scanの際には，線源とトリガシンチの間にモジュールを配置した．また，荷電粒子によるデータよりもノイズのデータを多く取得することを防ぐために，Diff FEの上半分，バイアス構造を持つ部分は全て非使用に設定した．Latency Scanの結果を図\ref{fig:exttriglatency}に示す．シンチレータと無関係の光子にMPPCが反応することや，ASICのDiff FE以外を通過した粒子が存在することから，1つの''LatencyConfig''値のトリガ数に対する取得イベント数が図\ref{fig:latencydist}よりも大きく減少しているのがわかる．しかし，この結果で1イベント取得されている''LatencyConfig''値・205でデータ取得した時とそこから離れた値である0でデータ取得を行った時のデータの差から''LatencyConfig''値を205を正しい''LatencyConfig''値と判断した．

\begin{figure}[h]
  \centering
  \includegraphics[width=14cm]{./figure/ExtLatencyDist.png}
  \caption{トリガシンチの場合の''LatencyConfig''値とL1ID $== 7$だったイベント数の関係}
  \label{fig:exttriglatency}
\end{figure}

Latencyを合わせた上で，図\ref{fig::extsetup}のセットアップで，トリガシンチの上に線源を設置した場合としない場合それぞれについて，30分間の外部トリガによるデータ取得を行なった．

\section{応答評価試験結果}
\label{sec:extconc}
表\ref{tab:ext}と図\ref{fig:ext}に線源をトリガシンチの上に設置した場合としない場合それぞれの，1時間の外部トリガによるデータ取得結果を示す．
\begin{table}[h]
  \centering
  \caption{線源の有無それぞれのヒットレート}
  \begin{tabular} {|l|c|c||c|} \hline
     & \# Hit & 時間[s] & Hitレート[hits/sec] \\  \hline
    線源なし & 8459 & 3600 & 2.33 \\ 
    線源あり & 283866 & 3600 & 78.85 \\ \hline
  \end{tabular}
  \label{tab:ext}
\end{table}

\begin{figure}[h]
  \centering
  \begin{minipage}[b]{0.45\linewidth}
    \centering
    \includegraphics[width=7cm]{./figure/exttrigwo.png}
    \subcaption{線源を置かない場合}
    \label{fig:extwo}
  \end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
    \centering
    \includegraphics[width=7cm]{./figure/exttrigw.png}
    \subcaption{線源を置いた場合}
    \label{fig:extw}
  \end{minipage}
  \caption{ヒットの分布}
  \label{fig:ext}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=10cm]{./figure/extperpix.png}
  \caption{外部トリガによるデータ取得の1ピクセルあたりのHit数分布}
  \label{fig:selfhitfreq}
\end{figure}

表\ref{tab:ext}より，線源あり，なしの場合でヒットレートに大きな差があり，図\ref{fig:ext}のようにヒット分布も線源なしの時に比べて，線源を置くと全面にヒットが増えることがわかる．
%ただし，線源が当たっていない部分も多く，トリガ数と取得されたデータ数の関係は表\ref{tab:exttrig}のようになる．
ただし，線源が当たっていない部分も多く，線源ありの場合にもなしの場合にもヒットが得られなかったピクセルが14489個存在した．線源なしの場合にヒット数が0だった場合と，ヒットが存在した場合で場合分けをして線源からの荷電粒子を観測したピクセル数を考察した．

\section{考察}
\label{sec:extsum}
\subsection*{線源なしの時のHit数が0だった場合}
線源がない場合にトリガが発行されるのは，トリガシンチのMPPCがシンチレータと関係ない光子を検出した時である．一方で，データとして取得されるのは，センサのノイズである．この2つは無関係であるため，線源なしの時にHit数が0になるのは\\

(MPPCがシンチレータと関係ない光子を検出するレート) $>$ (センサのノイズレート)\\

の場合である．MPPCがシンチレータと関係ない光子を検出するレートは$8.15 \mathrm{Hz}$である．線源ありの場合のトリガレートは，$255 \mathrm{Hz}$なので，MPPCによるトリガレートは，線源ありの場合のトリガレートの$3.2 \mathrm{\%}$に当たる．それよりもセンサのノイズレートが小さいため，今回は，線源を置いた場合に観測されたヒットは全て線源によるヒットであると判断した．\\
よって，荷電粒子によるヒット数と荷電粒子によるヒットを観測したピクセル数は表\ref{tab:ext0}のようになる．

\begin{table}
  \centering
  \caption{線源からのHitが存在するピクセル数}
  \label{tab:ext0}
  \begin{tabular}{cc}\hline
    線源によるヒット & 12457 \\
    線源からのヒットが存在したピクセル数 & 9369 \\ \hline
  \end{tabular}
\end{table}

\subsection*{線源ありの時のHit数が0より大きかった場合}
この場合\\

(MPPCがシンチレータと関係ない光子を検出するレート) $<$ (センサのノイズレート)\\

である．よって，取得されたデータにセンサのノイズが含まれるため，センサのノイズをバックグラウンドとして，それに対して線源からの有意な分布が見られるかを考えた．線源あり・なしで取得したToTの分布を図\ref{fig:exttot}に示す．線源ありの取得データに対して，線源なしの取得データが少なかったため，縦軸は1000トリガあたりのイベント数で規格化してある．この分布からToT $> 5$に線源からの荷電粒子によるデータが存在すると仮定し，以降ToT $>5$となるデータのみを使用した．荷電粒子によるヒットだと考えられる．

\begin{figure}[h]
  \centering
  \includegraphics[width=8cm]{./figure/extToT.png}
  \caption{線源の有り(赤)・無し(青)のToT分布}
  \label{fig:exttot}
\end{figure}


また，荷電粒子による信号を以下のように見積もった．この時も，線源ありとなしの場合で取得されたデータ数が異なるため，1トリガあたりの量で規格化している．
\begin{table}[h]
  \centering
  \caption{線源からの信号の分布の見積もり}
  \label{tb:extnon0}
  \begin{tabular}{cc} \hline
    $\mathrm{trig}$ & 線源ありの時のトリガ数 \\
    $\mathrm{trig_{bg}}$ & 線源なしの時のトリガ数 \\
    $n \pm \sqrt{n} /$ & 実測値  (線源ありの時のToT $>5$だったピクセルのヒット数) \\
    $n_{bg} \pm \sqrt{n_{bg}}$ & バックグラウンド  (線源なしの時のToT $>5$だったピクセルのヒット数)\\
    $n_{sig} = n/\mathrm{trig} - n_{bg}/\mathrm{trig_{bg}}$ & 見積もった真の線源からの規格化されたヒット数 \\ \hline
  \end{tabular}
\end{table}

表\ref{tb:selfnon0}のように，真の線源からのヒット数を見積もった上で，線源からのヒットがあったとみなすピクセルの条件を式\ref{eq:extnon0}のように定義した．

\begin{eqnarray}
  \label{eq:extnon0}
  \frac{n_{sig}}{\sqrt{n_{bg}}} > 5
\end{eqnarray}

この条件を満たす時，荷電粒子からのヒット数$n_{hit}$は式\ref{eq:extsource}のように定義した．
\begin{eqnarray}
  \label{eq:extnon0}
  n_{hit} = n \times \frac{n_{sig}}{n/trigger}
\end{eqnarray}

このように，荷電粒子によるヒット数と荷電粒子によるヒットを観測したピクセル数は表\ref{tab:extnon0}のようになる．
\begin{table}
  \centering
  \caption{線源からのHitが存在するピクセル数}
  \label{tab:extnon0}
  \begin{tabular}{cc}\hline
    線源によるヒット & 15 \\
    線源からのヒットが存在したピクセル数 & 8 \\ 
    線源ではないヒット &  271394\\
    線源からのヒットが存在しないピクセル数 & 16 \\ \hline
  \end{tabular}
\end{table}



\subsection*{まとめ}
1時間の外部トリガによるデータ取得によって，線源からの信号が取得できたヒットの状態を表\ref{tab:exthit}に示す．

\begin{table}[h]
  \centering
  \caption{1時間の外部トリガによるデータ取得からわかるピクセルの状態}
  \label{tab:exthit}
  \begin{tabular}{ccc} \hline
    ヒット数 & 全ヒット数に対する割合 & 状態 \\ \hline
    12472 & 4.4\% & 荷電粒子によるヒット\\
    271394 & 95.6\% & センサのノイズと考えられる信号\\ \hline
  \end{tabular}
\end{table}

また，1時間の外部トリガによるデータ取得によって，荷電粒子による信号が検出でき，品質保証が可能だったピクセルの分布を表\ref{tab:extconc}に示す．

\begin{table}[h]
  \centering
  \caption{1時間の外部トリガによるデータ取得からわかるピクセルの状態}
  \label{tab:extconc}
  \begin{tabular}{ccc} \hline
    ピクセル数 & 使用したピクセル数に対する割合 & 状態\\ \hline
    9377 & 39.26\% & 荷電粒子による信号を検出できた \\
    16 & 0.07\% & バックグラウンドに対して有意な信号が検出できない \\
    14489 & 60.67\% & 荷電粒子が当たっていないため判断できない \\ \hline
  \end{tabular}
\end{table}

すなわち，1時間の外部トリガによるデータ取得により，
\begin{itemize}
\item 荷電粒子のヒットレート：
\item ヒットが存在した：
\end{itemize}

  
  




